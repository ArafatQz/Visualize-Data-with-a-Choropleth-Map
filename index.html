<!DOCTYPE html>
<html>
<head>
    <title>US Education Choropleth Map</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/topojson-client@3"></script>
    <style>
        #tooltip {
            position: absolute;
            background: #fff;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            pointer-events: none;
            opacity: 0;
            font-family: Arial, sans-serif;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
        }
        .county:hover {
            stroke: #000;
            stroke-width: 0.5px;
        }
        #legend {
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div id="tooltip"></div>
    <script>
        const width = 960;
        const height = 600;
        const margin = { top: 60, right: 20, bottom: 60, left: 20 };

        const svg = d3.select("body")
            .append("svg")
            .attr("width", width)
            .attr("height", height);

        // Add title
        svg.append("text")
            .attr("id", "title")
            .attr("x", width / 2)
            .attr("y", margin.top / 2)
            .attr("text-anchor", "middle")
            .style("font-size", "24px")
            .text("United States Educational Attainment");

        // Add description
        svg.append("text")
            .attr("id", "description")
            .attr("x", width / 2)
            .attr("y", margin.top / 2 + 25)
            .attr("text-anchor", "middle")
            .style("font-size", "16px")
            .text("Percentage of adults age 25 and older with a bachelor's degree or higher (2010-2014)");

        Promise.all([
            d3.json("https://cdn.freecodecamp.org/testable-projects-fcc/data/choropleth_map/counties.json"),
            d3.json("https://cdn.freecodecamp.org/testable-projects-fcc/data/choropleth_map/for_user_education.json")
        ]).then(([countiesData, educationData]) => {
            const educationByFips = new Map(
                educationData.map(d => [d.fips, d.bachelorsOrHigher])
            );

            const colorScale = d3.scaleThreshold()
                .domain(d3.range(10, 70, 15))
                .range(d3.schemeBlues[5]);

            const projection = d3.geoAlbersUsa()
                .translate([width / 2, height / 2])
                .scale(1280);

            const path = d3.geoPath().projection(projection);

            // Draw counties
            svg.append("g")
                .selectAll("path")
                .data(topojson.feature(countiesData, countiesData.objects.counties).features)
                .enter()
                .append("path")
                .attr("class", "county")
                .attr("data-fips", d => d.id)
                .attr("data-education", d => educationByFips.get(d.id))
                .attr("d", path)
                .attr("fill", d => colorScale(educationByFips.get(d.id)))
                .on("mouseover", function(event, d) {
                    d3.select("#tooltip")
                        .style("opacity", 0.9)
                        .attr("data-education", educationByFips.get(d.id))
                        .html(`${d.properties.name}<br>${educationByFips.get(d.id)}%`)
                        .style("left", `${event.pageX + 10}px`)
                        .style("top", `${event.pageY - 28}px`);
                })
                .on("mouseout", function() {
                    d3.select("#tooltip").style("opacity", 0);
                });

            // Create legend
            const legend = svg.append("g")
                .attr("id", "legend")
                .attr("transform", `translate(${width - 200}, ${height - 200})`);

            const legendScale = d3.scaleLinear()
                .domain([0, 70])
                .range([0, 150]);

            const legendAxis = d3.axisBottom(legendScale)
                .tickValues(colorScale.domain())
                .tickFormat(d => `${d}%`);

            legend.selectAll("rect")
                .data(colorScale.range().map((color, i) => ({
                    color,
                    x0: i * 30,
                    x1: (i + 1) * 30
                })))
                .enter()
                .append("rect")
                .attr("x", (d, i) => i * 30)
                .attr("y", 0)
                .attr("width", 30)
                .attr("height", 20)
                .attr("fill", d => d.color);

            legend.append("g")
                .attr("transform", "translate(0, 20)")
                .call(legendAxis);
        });
    </script>
</body>
</html>